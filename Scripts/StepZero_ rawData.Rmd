---
title: "Step zero: convert raw exported csv files downloaded from the portal to a subject per row dataset"
author: "K L Purves"
date: '`r format(Sys.time(), "%d %B, %Y")`'

output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

# Important information before you run this script

This step uses the raw data downloaded from the FLARe portal. Both the user and rating data files need to be stored in the same folder on your computer.They should be called *users.csv* and *ratings.csv* respectively. This should not be in any folder that is synchronised with GitHub in order to ensure data security.

The first part of the script will ask you to select the most recent data rating file, and the remainder of the script will use that information to locate the correct files and datasets on your computer.

# Setup
This section will set up your environment ready to begin processing the data.


#### Clear global environment
```{r Clear global environment}
remove(list = ls())
```

#### load libraries 
This code block will check if you have the appropriate libraries installed. If you do not, it will download and install them for you. If you do, it will simply call them into your local library.

```{r Setup, libraries}

if(!require(reshape2)){
  install.packages("reshape2")
  library(reshape2)
}

if(!require(dplyr)){
  install.packages("dplyr")
  library(dplyr)
}

```

#### select ratings data, identify file path and file names

This block will ask you to find the *ratings data* on your computer. it will use this information to identify the right path for the user data, and to create a folder to store the processed data. 

```{r get files and paths}

## file picker
filename_ratings <- file.choose()

## get the path to the directory where the raw data is stored
raw_path <- dirname(filename)

## create the folders for each stage (note, this will do nothing if they already exist)
dir.create(file.path(raw_path, "StageZero_datasets"), showWarnings = FALSE)
dir.create(file.path(raw_path, "StageOne_datasets"), showWarnings = FALSE)
dir.create(file.path(raw_path, "StageTwo_datasets"), showWarnings = FALSE)
dir.create(file.path(raw_path, "Final_datasets"), showWarnings = FALSE)

## create exclusions directory
dir.create(file.path(raw_path, "Exclusions"), showWarnings = FALSE)


```

#### Set up filename and path variables for later

Having this here makes it easier to adjust if you want to change file or folder naming conventions to suit your project

```{r set up path and filenames}

# paths
exclusions_path <- file.path(raw_path, "Exclusions")
output_path <- file.path(raw_path, "StageZero_datasets")

# file names

file_ratings <- "affectiveRatings_stageZero.csv" 
file_acquisition <- "acquisition_stageZero.csv" 
file_generalisation <- "generalisation_stageZero.csv" 
file_extinction <- "extinction_stageZero.csv" 
file_return <- "returnFear_stageZero.csv" 
file_exclusions <- "dataDrivenExclusions_stageZero.csv" 

# users data reference

filename_users <- file.path(raw_path,"users.csv")
  
```


#### read in data

```{r read in raw data}
ratings <- read.table(filename_ratings,header = TRUE, sep=',')
users <- read.table(filename_users,header = TRUE, sep=',')
```


# Basic data cleaning

these steps clean the raw data , dropping data from test experiments and test subjects to retain only participants

## retain VCU experiment in users data
```{r data }
#identify users that were paticipants in the actual experiment data and nly retain these in our users data set
users <- users[(users$experiment_id == 12),] 

## drop all test IDs from this group. use regular expressions, ignoring case. order the file by user id 
users <- users %>%
  filter(!grepl("tes",username,ignore.case =T)) %>%
  arrange(username)

```

### match participants in the rating data
this step uses the user ids from our now filtered user data to get only the rating data we need

```{r retain correct users}
ratings <- ratings[(ratings$user_id %in% users$id_user),]
```

## get the column containing the scream stimulus ID ready for later use
This step creates a nice small dataframe which identifies which shape was the CS+ for each participant

```{r get scream stimulus column}

## create a long dataframe identifying which shape was the CS+ for each username
stimlong <- dcast(users,
                  username ~
                    scream_stimulus_id,
                  value.var = "scream_stimulus_id")

# Rename the columns appropriately

names(stimlong) <- c("Subject_ID","CSpA","CSpB")

# create a single easy column that identifies which was the CS+ for everyone. This is basically the same as scream_stimulus_id, but with the shapes named.
stimlong <- stimlong %>%
  mutate(CSpID = case_when(CSpA == 1 ~ "CSa",
                           CSpB == 2 ~ "CSb"))

stimid <- stimlong[c("Subject_ID","CSpID")]

```


## detect any epxeriment restarts and create an exclusions database
This stage will find instances where participants left the task at any stage (restarts) and flag these for consideration in the exclusions file

After restart column is identified, this chunk will identify when the restart occurred

1 - 4: affective ratings
5: acquisition
6: generalisation
7: extinction
8: return of fear
```{r identify restart column}
## create a wide data frame showing any restarts per phase
restart <- dcast(ratings,
                 user_id ~
                   phase_id,
                 value.var="detected_restart",
                 fun.aggregate = sum)

## limit it to our participants
restart <- restart[(restart$user_id %in% users$id_user),]

#identify any restarts during affective ratings
restart$restart_affective_ratings <- as.numeric(ifelse((restart$`1` > 0) |
                                           (restart$`2` >0) | 
                                           (restart$`3` >0) | 
                                           (restart$`4` >0),1,0))

 # identify restarts during any phase
restart$restart_acquisition <- as.numeric(ifelse((restart$`5` > 0),1,0))
restart$restart_generalisation <- as.numeric(ifelse((restart$`6` > 0),1,0))
restart$restart_extinction <- as.numeric(ifelse((restart$`7` > 0),1,0))
restart$restart_ROF <- as.numeric(ifelse((restart$`1` > 0),1,0))

```

turn this into the start of our exclusions dataset

```{r restart into exclusions}

exclusions <- restart %>%
  select(user_id, restart_affective_ratings, restart_acquisition,restart_generalisation,restart_extinction,restart_ROF)

```

# reshape affective and expectancy rating data

This stage will begin processing the critical experiment data.

